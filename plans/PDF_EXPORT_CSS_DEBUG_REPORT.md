# PDF Export CSS Debug Report

## Problem Summary

The CSS `@media print` styles for code block wrapping are NOT being applied during PDF export. Long code lines are still being clipped despite having correct `@media print` rules in all 6 stylesheets.

## Root Cause: CSS Specificity Conflict

### HTML Structure Generated by MacDown

When MacDown renders Markdown code blocks, it generates this HTML structure (see `hoedown_html_patch.c` lines 58-84):

```html
<div><pre><code class="language-xxx">
  code content here
</code></pre></div>
```

**Key Point**: The code content is wrapped in BOTH `<pre>` AND `<code>` elements.

### CSS Specificity Issue

The stylesheets have this pattern:

**Base Styles (Screen)**:
```css
pre {
    overflow: auto;
}

pre code {
    white-space: pre;    /* Specificity: 0-0-2 (two elements) */
    border: none;
    background: transparent;
}

code, tt {
    white-space: nowrap;  /* Specificity: 0-0-1 */
}
```

**Print Styles**:
```css
@media print {
    pre {
        white-space: pre-wrap !important;  /* Specificity: 0-0-1 */
        overflow-wrap: break-word;
    }
    code, tt {
        white-space: pre-wrap !important;  /* Specificity: 0-0-1 */
        overflow-wrap: break-word;
    }
}
```

### Why It Doesn't Work

When rendering `<pre><code>`, the browser applies CSS in this order of specificity:

1. **`pre` selector**: Both base and @media print rules apply
   - Base: `overflow: auto`
   - Print: `white-space: pre-wrap !important` ✅

2. **`code` selector**: Both base and @media print rules apply
   - Base: `white-space: nowrap`
   - Print: `white-space: pre-wrap !important` ✅

3. **`pre code` selector**: ONLY base rules apply! ❌
   - Base: `white-space: pre` (Specificity: 0-0-2)
   - **Print: NONE** (No `pre code` selector in @media print section)

**The `pre code` selector (0-0-2) is more specific than both `pre` (0-0-1) and `code` (0-0-1), so even with `!important`, the @media print rules don't override it.**

## Affected Files

All 6 CSS stylesheets in `MacDown/Resources/Styles/`:

1. ✅ `Clearness.css` - Has `pre code` selector in base styles
2. ✅ `Clearness Dark.css` - Has `pre code` selector in base styles
3. ✅ `GitHub.css` - Has `pre code` selector in base styles
4. ✅ `GitHub2.css` - Has `pre code` selector in base styles (line 248-253)
5. ❓ `Solarized (Light).css` - May not have `pre code` selector
6. ❓ `Solarized (Dark).css` - May not have `pre code` selector

## Evidence

### GitHub2.css Example

**Lines 240-275** (Base styles):
```css
code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;   /* ← Prevents wrapping for inline code */
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;      /* ← THIS OVERRIDES @media print! */
  border: none;
  background: transparent;
}
```

**Lines 305-321** (@media print):
```css
@media print {
    table, pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
        white-space: pre-wrap !important;
        overflow-wrap: break-word;
    }
    code, tt {
        white-space: pre-wrap !important;
        overflow-wrap: break-word;
    }
    body {
        padding: 2cm;
    }
}
```

**MISSING**: `pre code` and `pre tt` selectors in @media print section!

## The Fix

Add `pre code` and `pre tt` selectors to the `@media print` section in ALL stylesheets:

```css
@media print {
    table, pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
        white-space: pre-wrap !important;
        overflow-wrap: break-word;
    }
    /* Add these missing selectors: */
    pre code, pre tt {
        white-space: pre-wrap !important;
        overflow-wrap: break-word;
    }
    code, tt {
        white-space: pre-wrap !important;
        overflow-wrap: break-word;
    }
    body {
        padding: 2cm;
    }
}
```

## How PDF Export Works

1. **Rendering**: MPRenderer.m generates HTML with linked CSS files using `<link rel="stylesheet" href="file://...">` tags
2. **Print Operation**: MPDocument.m creates print operation from WebView using `WebFrameView.printOperationWithPrintInfo:`
3. **CSS Loading**: WebKit loads the linked CSS files and applies @media print rules
4. **Problem**: Due to specificity, the `pre code` base style overrides the @media print rules

## Why This Wasn't Caught Earlier

1. The @media print section LOOKS correct at first glance
2. All selectors have `!important` declarations
3. The issue only affects code blocks (not inline code or other elements)
4. Testing requires actually generating PDFs and checking for overflow

## Testing Verification

After applying the fix, test with these files in `plans/test-pdf-export-samples/`:
- `00-comprehensive-test.md` - All scenarios in one file
- Test with ALL 6 themes
- Verify long code lines wrap without clipping

## Additional Notes

### PDF Export Flow (MPDocument.m)

```objc
// Line 622-631: Creates print operation
- (NSPrintOperation *)printOperationWithSettings:(NSDictionary *)printSettings
                                           error:(NSError **)e
{
    NSPrintInfo *info = [self.printInfo copy];
    [info.dictionary addEntriesFromDictionary:printSettings];

    WebFrameView *view = self.preview.mainFrame.frameView;
    NSPrintOperation *op = [view printOperationWithPrintInfo:info];
    return op;
}

// Line 1274-1297: Export to PDF
- (IBAction)exportPdf:(id)sender
{
    // Shows save panel, then calls printDocumentWithSettings
    [self printDocumentWithSettings:settings showPrintPanel:NO ...];
}
```

### HTML Template (Default.handlebars)

The CSS is injected via styleTags which are generated by MPAsset.m:

```html
<head>
{{#each styleTags }}
{{{ this }}}  <!-- Expands to <link rel="stylesheet" href="file://..."> -->
{{/each }}
</head>
```

## Conclusion

**The @media print styles are NOT broken**. They ARE being loaded and applied by WebKit. The issue is purely **CSS specificity** - the `pre code` selector in base styles overrides the less specific `pre` and `code` selectors in @media print.

**Solution**: Add `pre code, pre tt` to all @media print sections.

---

## Update: Implemented Solution (2025-11-20)

While the CSS specificity analysis in this document was **correct**, the proposed fix (adding `pre code` selectors to all 6 theme files) was **superseded** by a different approach.

**Actual Implementation:**

Instead of modifying 6 theme CSS files individually, a **universal print stylesheet** was created:

- **File:** `MacDown/Resources/Extensions/print.css`
- **Loading:** Added to MPRenderer.m to load LAST (after all theme CSS)
- **Result:** Single file overrides all themes via cascade order + specificity + !important

This approach is more maintainable and works universally across all themes without per-theme modifications.

See `ISSUE_28_INVESTIGATION.md` for complete resolution details.

---

## Related Implementation: Issue #30 (HTML Export)

The same universal stylesheet pattern was applied to HTML exports:

- **File:** `MacDown/Resources/Extensions/export.css`
- **Purpose:** Word-breaking rules for paragraph text in HTML exports
- **Implementation:** Loads LAST in MPRenderer.m stylesheet cascade
- **Test Suite:** `MPHTMLExportTests.m`

This demonstrates the effectiveness of the universal stylesheet approach for export-specific styling needs.
