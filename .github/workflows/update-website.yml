name: Update Website with Latest Release

on:
  release:
    types: [published]

jobs:
  update-website:
    name: Update Website Download Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Fetching latest release information..."

          # Get the latest release (not draft, not pre-release)
          gh release list --limit 1 --exclude-drafts --exclude-pre-releases --json tagName,url,publishedAt,assets > release.json

          # Extract release info
          TAG_NAME=$(jq -r '.[0].tagName' release.json)

          # Validate that a release was found
          if [[ "$TAG_NAME" == "null" ]] || [[ -z "$TAG_NAME" ]]; then
            echo "â„¹ï¸ No published stable releases found, skipping website update"
            echo "This is expected if only pre-releases or drafts exist."
            exit 0
          fi

          RELEASE_URL=$(jq -r '.[0].url' release.json)
          PUBLISHED_AT=$(jq -r '.[0].publishedAt' release.json)
          VERSION="${TAG_NAME#v}"

          # Find DMG asset
          DMG_NAME=$(jq -r '.[0].assets[] | select(.name | endswith(".dmg")) | .name' release.json)
          DMG_SIZE=$(jq -r '.[0].assets[] | select(.name | endswith(".dmg")) | .size' release.json)
          DMG_SIZE_MB=$(echo "scale=1; $DMG_SIZE / 1024 / 1024" | bc)

          # Build download URLs
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}"
          CHECKSUM_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}.sha256"

          echo "âœ… Found release: $VERSION"

          # Update the data file (Jekyll will use this via Liquid templating)
          cat > docs/_data/latest.json <<EOF
          {
            "version": "$VERSION",
            "tagName": "$TAG_NAME",
            "releaseUrl": "$RELEASE_URL",
            "publishedAt": "$PUBLISHED_AT",
            "downloadUrl": "$DOWNLOAD_URL",
            "dmgName": "$DMG_NAME",
            "dmgSizeMB": "$DMG_SIZE_MB",
            "checksumUrl": "$CHECKSUM_URL",
            "updatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "âœ… Updated docs/_data/latest.json"
          cat docs/_data/latest.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/_data/latest.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update website with release ${VERSION}

          Auto-generated by update-website workflow."

          git push

          echo "âœ… Data file updated"
          echo "ðŸŒ Jekyll will regenerate the website automatically"
