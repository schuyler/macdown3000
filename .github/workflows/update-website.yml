name: Update Website with Latest Release

on:
  workflow_run:
    workflows: ["Staple and Publish Release"]
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to commit and push website updates

jobs:
  update-website:
    name: Update Website Download Links
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Fetching latest release information..."

          # Get the latest release (gh release view without a tag shows the latest)
          gh release view --json tagName,publishedAt,assets,url > release.json

          # Extract release info
          TAG_NAME=$(jq -r '.tagName' release.json)
          PUBLISHED_AT=$(jq -r '.publishedAt' release.json)
          RELEASE_URL=$(jq -r '.url' release.json)
          VERSION="${TAG_NAME#v}"

          # Find DMG asset
          DMG_NAME=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .name' release.json)
          DMG_SIZE=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .size' release.json)
          DMG_SIZE_MB=$(echo "scale=1; $DMG_SIZE / 1024 / 1024" | bc)

          # Build download URLs
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}"
          CHECKSUM_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}.sha256"

          echo "âœ… Found release: $VERSION"

          # Update the data file (Jekyll will use this via Liquid templating)
          cat > docs/_data/latest.json <<EOF
          {
            "version": "$VERSION",
            "tagName": "$TAG_NAME",
            "releaseUrl": "$RELEASE_URL",
            "publishedAt": "$PUBLISHED_AT",
            "downloadUrl": "$DOWNLOAD_URL",
            "dmgName": "$DMG_NAME",
            "dmgSizeMB": "$DMG_SIZE_MB",
            "checksumUrl": "$CHECKSUM_URL",
            "updatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "âœ… Updated docs/_data/latest.json"
          cat docs/_data/latest.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/_data/latest.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update website with release ${VERSION}

          Auto-generated by update-website workflow."

          git push

          echo "âœ… Data file updated"
          echo "ðŸŒ Jekyll will regenerate the website automatically"
