name: Update Website with Latest Release

on:
  workflow_run:
    workflows: ["Staple and Publish Release"]
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to commit and push website updates

jobs:
  update-website:
    name: Update Website Download Links
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì• Fetching latest release information..."

          # Get the latest release (gh release view without a tag shows the latest)
          if ! gh release view --json tagName,publishedAt,assets,url > release.json 2>/dev/null; then
            echo "‚ùå Error: No releases found in repository"
            exit 1
          fi

          # Extract release info
          TAG_NAME=$(jq -r '.tagName' release.json)
          PUBLISHED_AT=$(jq -r '.publishedAt' release.json)
          RELEASE_URL=$(jq -r '.url' release.json)
          VERSION="${TAG_NAME#v}"

          # Validate we got valid data
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            echo "‚ùå Error: Failed to extract tag name from release"
            exit 1
          fi

          # Find DMG asset
          DMG_NAME=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .name' release.json)
          DMG_SIZE=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .size' release.json)

          # Validate DMG exists
          if [ -z "$DMG_NAME" ] || [ "$DMG_NAME" = "null" ]; then
            echo "‚ùå Error: No DMG file found in release $TAG_NAME"
            echo "Available assets:"
            jq -r '.assets[].name' release.json
            exit 1
          fi

          # Calculate size (now safe because we validated DMG_SIZE exists)
          DMG_SIZE_MB=$(echo "scale=1; $DMG_SIZE / 1024 / 1024" | bc)

          # Build download URLs
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}"
          CHECKSUM_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${DMG_NAME}.sha256"

          echo "‚úÖ Found release: $VERSION"

          # Export VERSION for use in next step
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Update the data file (Jekyll will use this via Liquid templating)
          jq -n \
            --arg version "$VERSION" \
            --arg tagName "$TAG_NAME" \
            --arg releaseUrl "$RELEASE_URL" \
            --arg publishedAt "$PUBLISHED_AT" \
            --arg downloadUrl "$DOWNLOAD_URL" \
            --arg dmgName "$DMG_NAME" \
            --arg dmgSizeMB "$DMG_SIZE_MB" \
            --arg checksumUrl "$CHECKSUM_URL" \
            --arg updatedAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              version: $version,
              tagName: $tagName,
              releaseUrl: $releaseUrl,
              publishedAt: $publishedAt,
              downloadUrl: $downloadUrl,
              dmgName: $dmgName,
              dmgSizeMB: $dmgSizeMB,
              checksumUrl: $checksumUrl,
              updatedAt: $updatedAt
            }' > docs/_data/latest.json

          echo "‚úÖ Updated docs/_data/latest.json"
          cat docs/_data/latest.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/_data/latest.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update website with release ${VERSION}

          Auto-generated by update-website workflow."

          # Push with retry logic (per CLAUDE.md: retry up to 4 times with exponential backoff)
          MAX_RETRIES=4
          RETRY_COUNT=0
          BACKOFF=2

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push; then
              echo "‚úÖ Data file updated"
              echo "üåê Jekyll will regenerate the website automatically"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Push failed, retrying in ${BACKOFF}s (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
                sleep $BACKOFF
                BACKOFF=$((BACKOFF * 2))
              else
                echo "‚ùå Push failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
