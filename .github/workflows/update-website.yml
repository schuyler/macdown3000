name: Update Website with Latest Release

on:
  workflow_run:
    workflows: ["Staple and Publish Release"]
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to commit and push website updates

jobs:
  update-website:
    name: Update Website Download Links
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì• Fetching latest release information..."

          # Function to extract release details
          extract_release_info() {
            local TAG=$1
            local OUTPUT_VAR_PREFIX=$2

            if ! gh release view "$TAG" --json tagName,publishedAt,assets,url,isPrerelease > "release_${OUTPUT_VAR_PREFIX}.json" 2>/dev/null; then
              return 1
            fi

            local tag_name=$(jq -r '.tagName' "release_${OUTPUT_VAR_PREFIX}.json")
            local published_at=$(jq -r '.publishedAt' "release_${OUTPUT_VAR_PREFIX}.json")
            local release_url=$(jq -r '.url' "release_${OUTPUT_VAR_PREFIX}.json")
            local version="${tag_name#v}"

            # Find DMG asset
            local dmg_name=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .name' "release_${OUTPUT_VAR_PREFIX}.json")
            local dmg_size=$(jq -r '.assets[] | select(.name | endswith(".dmg")) | .size' "release_${OUTPUT_VAR_PREFIX}.json")

            if [ -z "$dmg_name" ] || [ "$dmg_name" = "null" ]; then
              echo "‚ö†Ô∏è  No DMG found for $TAG"
              return 1
            fi

            local dmg_size_mb=$(echo "scale=1; $dmg_size / 1024 / 1024" | bc)
            local download_url="https://github.com/${{ github.repository }}/releases/download/${tag_name}/${dmg_name}"
            local checksum_url="https://github.com/${{ github.repository }}/releases/download/${tag_name}/${dmg_name}.sha256"

            # Export variables with prefix
            eval "${OUTPUT_VAR_PREFIX}_VERSION='$version'"
            eval "${OUTPUT_VAR_PREFIX}_TAG_NAME='$tag_name'"
            eval "${OUTPUT_VAR_PREFIX}_PUBLISHED_AT='$published_at'"
            eval "${OUTPUT_VAR_PREFIX}_RELEASE_URL='$release_url'"
            eval "${OUTPUT_VAR_PREFIX}_DMG_NAME='$dmg_name'"
            eval "${OUTPUT_VAR_PREFIX}_DMG_SIZE_MB='$dmg_size_mb'"
            eval "${OUTPUT_VAR_PREFIX}_DOWNLOAD_URL='$download_url'"
            eval "${OUTPUT_VAR_PREFIX}_CHECKSUM_URL='$checksum_url'"

            return 0
          }

          # Get latest stable release (non-pre-release)
          STABLE_TAG=$(gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json tagName --jq '.[0].tagName')

          # Get latest pre-release
          PRERELEASE_TAG=$(gh release list --exclude-drafts --limit 1 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' | head -1)

          # Process stable release if it exists
          HAS_STABLE=false
          if [ -n "$STABLE_TAG" ] && [ "$STABLE_TAG" != "null" ]; then
            echo "Found stable release: $STABLE_TAG"
            if extract_release_info "$STABLE_TAG" "STABLE"; then
              HAS_STABLE=true
              echo "‚úÖ Stable release: $STABLE_VERSION"
            fi
          fi

          # Process pre-release if it exists
          HAS_PRERELEASE=false
          if [ -n "$PRERELEASE_TAG" ] && [ "$PRERELEASE_TAG" != "null" ]; then
            echo "Found pre-release: $PRERELEASE_TAG"
            if extract_release_info "$PRERELEASE_TAG" "PRERELEASE"; then
              HAS_PRERELEASE=true
              echo "‚úÖ Pre-release: $PRERELEASE_VERSION"
            fi
          fi

          # Ensure we have at least one release
          if [ "$HAS_STABLE" = "false" ] && [ "$HAS_PRERELEASE" = "false" ]; then
            echo "‚ùå Error: No published releases found in repository"
            exit 1
          fi

          # Export VERSION for commit message (use stable if available, otherwise prerelease)
          if [ "$HAS_STABLE" = "true" ]; then
            echo "VERSION=$STABLE_VERSION" >> $GITHUB_ENV
          else
            echo "VERSION=$PRERELEASE_VERSION" >> $GITHUB_ENV
          fi

          # Build JSON data file
          UPDATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          if [ "$HAS_STABLE" = "true" ] && [ "$HAS_PRERELEASE" = "true" ]; then
            # Both stable and pre-release exist
            jq -n \
              --arg stableVersion "$STABLE_VERSION" \
              --arg stableTagName "$STABLE_TAG_NAME" \
              --arg stableReleaseUrl "$STABLE_RELEASE_URL" \
              --arg stablePublishedAt "$STABLE_PUBLISHED_AT" \
              --arg stableDownloadUrl "$STABLE_DOWNLOAD_URL" \
              --arg stableDmgName "$STABLE_DMG_NAME" \
              --arg stableDmgSizeMB "$STABLE_DMG_SIZE_MB" \
              --arg stableChecksumUrl "$STABLE_CHECKSUM_URL" \
              --arg prereleaseVersion "$PRERELEASE_VERSION" \
              --arg prereleaseTagName "$PRERELEASE_TAG_NAME" \
              --arg prereleaseReleaseUrl "$PRERELEASE_RELEASE_URL" \
              --arg prereleasePublishedAt "$PRERELEASE_PUBLISHED_AT" \
              --arg prereleaseDownloadUrl "$PRERELEASE_DOWNLOAD_URL" \
              --arg prereleaseDmgName "$PRERELEASE_DMG_NAME" \
              --arg prereleaseDmgSizeMB "$PRERELEASE_DMG_SIZE_MB" \
              --arg prereleaseChecksumUrl "$PRERELEASE_CHECKSUM_URL" \
              --arg updatedAt "$UPDATED_AT" \
              '{
                stable: {
                  version: $stableVersion,
                  tagName: $stableTagName,
                  releaseUrl: $stableReleaseUrl,
                  publishedAt: $stablePublishedAt,
                  downloadUrl: $stableDownloadUrl,
                  dmgName: $stableDmgName,
                  dmgSizeMB: $stableDmgSizeMB,
                  checksumUrl: $stableChecksumUrl
                },
                prerelease: {
                  version: $prereleaseVersion,
                  tagName: $prereleaseTagName,
                  releaseUrl: $prereleaseReleaseUrl,
                  publishedAt: $prereleasePublishedAt,
                  downloadUrl: $prereleaseDownloadUrl,
                  dmgName: $prereleaseDmgName,
                  dmgSizeMB: $prereleaseDmgSizeMB,
                  checksumUrl: $prereleaseChecksumUrl
                },
                updatedAt: $updatedAt
              }' > docs/_data/latest.json
          elif [ "$HAS_STABLE" = "true" ]; then
            # Only stable release exists
            jq -n \
              --arg version "$STABLE_VERSION" \
              --arg tagName "$STABLE_TAG_NAME" \
              --arg releaseUrl "$STABLE_RELEASE_URL" \
              --arg publishedAt "$STABLE_PUBLISHED_AT" \
              --arg downloadUrl "$STABLE_DOWNLOAD_URL" \
              --arg dmgName "$STABLE_DMG_NAME" \
              --arg dmgSizeMB "$STABLE_DMG_SIZE_MB" \
              --arg checksumUrl "$STABLE_CHECKSUM_URL" \
              --arg updatedAt "$UPDATED_AT" \
              '{
                stable: {
                  version: $version,
                  tagName: $tagName,
                  releaseUrl: $releaseUrl,
                  publishedAt: $publishedAt,
                  downloadUrl: $downloadUrl,
                  dmgName: $dmgName,
                  dmgSizeMB: $dmgSizeMB,
                  checksumUrl: $checksumUrl
                },
                updatedAt: $updatedAt
              }' > docs/_data/latest.json
          else
            # Only pre-release exists
            jq -n \
              --arg version "$PRERELEASE_VERSION" \
              --arg tagName "$PRERELEASE_TAG_NAME" \
              --arg releaseUrl "$PRERELEASE_RELEASE_URL" \
              --arg publishedAt "$PRERELEASE_PUBLISHED_AT" \
              --arg downloadUrl "$PRERELEASE_DOWNLOAD_URL" \
              --arg dmgName "$PRERELEASE_DMG_NAME" \
              --arg dmgSizeMB "$PRERELEASE_DMG_SIZE_MB" \
              --arg checksumUrl "$PRERELEASE_CHECKSUM_URL" \
              --arg updatedAt "$UPDATED_AT" \
              '{
                prerelease: {
                  version: $version,
                  tagName: $tagName,
                  releaseUrl: $releaseUrl,
                  publishedAt: $publishedAt,
                  downloadUrl: $downloadUrl,
                  dmgName: $dmgName,
                  dmgSizeMB: $dmgSizeMB,
                  checksumUrl: $checksumUrl
                },
                updatedAt: $updatedAt
              }' > docs/_data/latest.json
          fi

          echo "‚úÖ Updated docs/_data/latest.json"
          cat docs/_data/latest.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/_data/latest.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update website with release ${VERSION}

          Auto-generated by update-website workflow."

          # Push with retry logic (per CLAUDE.md: retry up to 4 times with exponential backoff)
          MAX_RETRIES=4
          RETRY_COUNT=0
          BACKOFF=2

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push; then
              echo "‚úÖ Data file updated"
              echo "üåê Jekyll will regenerate the website automatically"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Push failed, retrying in ${BACKOFF}s (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
                sleep $BACKOFF
                BACKOFF=$((BACKOFF * 2))
              else
                echo "‚ùå Push failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
