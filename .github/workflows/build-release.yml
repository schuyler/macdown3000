name: Verify Release Build

on:
  push:
    branches: [ main ]
    # Verify Release configuration builds successfully on every merge to main
    # This catches build issues before attempting an actual release
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  verify-release-build:
    name: Verify Release Build (Dry Run)
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MacDown build environment
        uses: ./.github/actions/setup-macdown

      - name: Build MacDown (unsigned)
        timeout-minutes: 30
        uses: ./.github/actions/build-macdown
        with:
          enable-signing: false

      - name: Verify universal binary
        run: |
          echo "üîç Verifying architectures..."
          LIPO_OUTPUT=$(lipo -info build/"MacDown 3000.app"/Contents/MacOS/MacDown*)
          echo "$LIPO_OUTPUT"

          # Verify it's a universal binary (check for both architectures)
          if echo "$LIPO_OUTPUT" | grep -q "arm64" && echo "$LIPO_OUTPUT" | grep -q "x86_64"; then
            echo "‚úÖ Confirmed: Universal binary (arm64 + x86_64)"
          else
            echo "::error::Build is not a universal binary!"
            exit 1
          fi

          echo "‚úÖ Release build verification passed"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: MacDown-unsigned-dmg
          path: build/MacDown-*.dmg
          retention-days: 7

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log
          retention-days: 7
