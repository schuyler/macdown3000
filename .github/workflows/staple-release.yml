name: Staple and Publish Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v3000.0.0-beta.1)'
        required: true
        type: string

permissions:
  contents: write  # Required to update release assets and notes

jobs:
  staple:
    name: Staple Notarization and Update Release
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        run: |
          TAG="${{ github.event.inputs.release_tag }}"
          VERSION=${TAG#v}  # Remove 'v' prefix
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Get release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Fetching release information for $TAG..."

          # Get release ID and body
          gh release view "$TAG" --json id,body > release-info.json

          RELEASE_ID=$(jq -r '.id' release-info.json)
          RELEASE_BODY=$(jq -r '.body' release-info.json)

          # Extract notarization submission ID from release notes
          NOTARIZATION_ID=$(echo "$RELEASE_BODY" | grep -oE 'Submission ID: `[^`]+`' | sed 's/Submission ID: `\(.*\)`/\1/' || echo "")

          if [[ -z "$NOTARIZATION_ID" ]]; then
            echo "::error::Could not find notarization submission ID in release notes"
            echo "Please ensure this release was created by the release workflow"
            exit 1
          fi

          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "NOTARIZATION_ID=$NOTARIZATION_ID" >> $GITHUB_ENV

          echo "âœ… Found release"
          echo "   Release ID: $RELEASE_ID"
          echo "   Notarization ID: $NOTARIZATION_ID"

      - name: Verify notarization status
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ðŸ” Checking notarization status..."

          # Get notarization info
          xcrun notarytool info "$NOTARIZATION_ID" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json > notarization-info.json

          STATUS=$(jq -r '.status' notarization-info.json)

          echo "Status: $STATUS"

          if [[ "$STATUS" != "Accepted" ]]; then
            echo "::error::Notarization status is '$STATUS', not 'Accepted'"
            echo ""
            echo "Current status: $STATUS"
            echo ""
            if [[ "$STATUS" == "In Progress" ]]; then
              echo "Notarization is still in progress. Please wait for Apple's email and try again."
            elif [[ "$STATUS" == "Invalid" ]]; then
              echo "Notarization was rejected. Getting detailed log..."
              xcrun notarytool log "$NOTARIZATION_ID" \
                --apple-id "$APPLE_ID" \
                --password "$APPLE_APP_PASSWORD" \
                --team-id "$APPLE_TEAM_ID" \
                developer_log.json || true
              if [[ -f developer_log.json ]]; then
                cat developer_log.json
              fi
            fi
            exit 1
          fi

          echo "âœ… Notarization accepted by Apple"

      - name: Download and verify DMG from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Downloading DMG and checksum from release..."

          # Download the DMG and checksum
          gh release download "$TAG" \
            --pattern "MacDown-${VERSION}.dmg*" \
            --dir build

          echo "âœ… DMG and checksum downloaded"
          ls -lh build/

          # Verify checksum
          echo "ðŸ” Verifying DMG integrity..."
          cd build
          shasum -a 256 -c "MacDown-${VERSION}.dmg.sha256"
          cd ..

          # Verify DMG signature
          echo "ðŸ” Verifying DMG signature..."
          codesign -vvv --strict "build/MacDown-${VERSION}.dmg"

          # Verify it's signed with Developer ID
          SIGNING_IDENTITY=$(codesign -dvv "build/MacDown-${VERSION}.dmg" 2>&1 | grep "Authority=Developer ID Application")
          if [[ -z "$SIGNING_IDENTITY" ]]; then
            echo "::error::Downloaded DMG is not properly signed"
            exit 1
          fi

          echo "âœ… DMG verified and ready for stapling"

      - name: Staple notarization ticket
        run: |
          echo "ðŸ“Ž Stapling notarization ticket to DMG..."

          # Staple the ticket
          xcrun stapler staple "build/MacDown-${VERSION}.dmg"

          # Validate stapling
          echo "ðŸ” Validating stapled ticket..."
          xcrun stapler validate "build/MacDown-${VERSION}.dmg"

          # Re-verify code signature after stapling
          echo "ðŸ” Verifying code signature is intact after stapling..."
          codesign -vvv --strict "build/MacDown-${VERSION}.dmg"

          # Verify with spctl
          echo "ðŸ” Verifying Gatekeeper acceptance..."
          spctl -a -vvv -t install "build/MacDown-${VERSION}.dmg"

          echo "âœ… DMG successfully stapled and verified"

      - name: Generate updated checksums
        run: |
          echo "ðŸ” Generating checksums for stapled DMG..."

          cd build
          shasum -a 256 "MacDown-${VERSION}.dmg" > "MacDown-${VERSION}.dmg.sha256"

          echo "Checksum:"
          cat "MacDown-${VERSION}.dmg.sha256"

          # Save for release notes
          CHECKSUM=$(cat "MacDown-${VERSION}.dmg.sha256")
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV

          echo "âœ… Checksums generated"

      - name: Final comprehensive verification
        run: |
          echo "ðŸ” Running final comprehensive verification before publishing..."

          DMG_PATH="build/MacDown-${VERSION}.dmg"

          # 1. Verify DMG signature
          echo "  âœ“ Checking DMG signature..."
          codesign -vvv --strict "$DMG_PATH"

          # 2. Verify notarization staple
          echo "  âœ“ Checking notarization staple..."
          xcrun stapler validate "$DMG_PATH"

          # 3. Verify Gatekeeper acceptance
          echo "  âœ“ Checking Gatekeeper acceptance..."
          spctl -a -vvv -t install "$DMG_PATH"

          # 4. Mount and verify app inside DMG
          echo "  âœ“ Checking app bundle inside DMG..."
          hdiutil attach "$DMG_PATH" -mountpoint /tmp/final-verify -nobrowse -readonly
          codesign -vvv --deep --strict "/tmp/final-verify/MacDown 3000.app"

          # Get app version for logging
          APP_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" \
                        "/tmp/final-verify/MacDown 3000.app/Contents/Info.plist" 2>/dev/null || echo "unknown")
          echo "    App version: $APP_VERSION"

          hdiutil detach /tmp/final-verify

          # 5. Verify checksum matches
          echo "  âœ“ Verifying checksum..."
          cd build
          shasum -a 256 -c "MacDown-${VERSION}.dmg.sha256"
          cd ..

          echo ""
          echo "âœ… All verification checks passed!"
          echo "ðŸŽ‰ DMG is ready for distribution"
          echo ""

      - name: Update release with stapled DMG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¤ Updating release with stapled DMG..."

          # Upload stapled DMG and new checksum
          # --clobber replaces existing assets atomically (no race condition)
          gh release upload "$TAG" \
            "build/MacDown-${VERSION}.dmg" \
            "build/MacDown-${VERSION}.dmg.sha256" \
            --clobber

          echo "âœ… Release updated with stapled DMG (assets replaced atomically)"

      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ðŸ“ Updating release notes..."

          # Verify changelog entry exists
          if ! grep -q "^## \[${VERSION}\]" CHANGELOG.md; then
            echo "::error::No changelog entry found for version ${VERSION}"
            echo "::error::Please add a changelog entry to CHANGELOG.md"
            exit 1
          fi

          # Extract changelog for this version
          echo "Extracting changelog for version ${VERSION}..."

          # Use awk with string matching (not regex) to extract the section
          CHANGELOG_CONTENT=$(awk -v ver="${VERSION}" '
            /^## \[/ {
              if (found) exit
              if (index($0, "[" ver "]") > 0) {
                found=1
                next
              }
            }
            found && /^## / { exit }
            found && !/^---$/ { print }
          ' CHANGELOG.md)

          if [ -z "$CHANGELOG_CONTENT" ]; then
            echo "::error::Failed to extract changelog content for version ${VERSION}"
            exit 1
          fi

          echo "âœ… Extracted changelog for version ${VERSION}"

          # Create release notes with changelog + installation/verification details
          cat > release-notes.md <<EOF
          **MacDown 3000** is a modern, open-source Markdown editor for macOS.

          ${CHANGELOG_CONTENT}

          ## Installation

          **Platform:** macOS 10.14 or later (Universal - Apple Silicon and Intel)

          1. Download \`MacDown-${VERSION}.dmg\` below
          2. Open the DMG
          3. Drag MacDown 3000.app to your Applications folder
          4. Launch from Applications

          âœ… This app is **fully notarized and stapled** by Apple - it will open without security warnings.

          ## Verification

          **SHA256 Checksum:**
          \`\`\`
          ${CHECKSUM}
          \`\`\`

          Verify after download:
          \`\`\`bash
          shasum -a 256 MacDown-${VERSION}.dmg
          \`\`\`

          ---

          **Full Changelog:** https://github.com/${GITHUB_REPOSITORY}/blob/main/CHANGELOG.md
          EOF

          # Update the release notes
          gh release edit "$TAG" --notes-file release-notes.md

          echo "âœ… Release notes updated"
          echo ""
          echo "ðŸŽ‰ Release is now ready for publication!"
          echo "   View at: https://github.com/${GITHUB_REPOSITORY}/releases/tag/$TAG"
